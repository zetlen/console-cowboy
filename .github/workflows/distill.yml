name: Distill Semantic Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  distill:
    name: Analyze PR Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Distill
        run: npm install -g @distill/cli

      - name: Run Distill Analysis
        id: distill
        run: |
          # Get the base and head refs
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Analyzing changes from $BASE_SHA to $HEAD_SHA"

          # Run distill and capture output
          DISTILL_OUTPUT=$(distill diff "$BASE_SHA" "$HEAD_SHA" 2>&1) || true

          # Check if there's meaningful output
          if [ -z "$(echo "$DISTILL_OUTPUT" | tr -d '[:space:]')" ]; then
            DISTILL_OUTPUT="‚úÖ No semantic signals detected in this PR."
          fi

          # Write to file (GitHub Actions has issues with multiline in outputs)
          echo "$DISTILL_OUTPUT" > distill-output.md

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- distill-analysis -->'

      - name: Build comment body
        id: build-comment
        run: |
          {
            echo '<!-- distill-analysis -->'
            echo '## üîç Distill Semantic Analysis'
            echo ''
            echo '<details>'
            echo '<summary>Click to expand analysis results</summary>'
            echo ''
            echo '```'
            cat distill-output.md
            echo '```'
            echo ''
            echo '</details>'
            echo ''
            echo '---'
            echo "<sub>Generated by [Distill](https://github.com/zetlen/distill) ‚Ä¢ Commit ${{ github.event.pull_request.head.sha }}</sub>"
          } > comment-body.md

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: comment-body.md
